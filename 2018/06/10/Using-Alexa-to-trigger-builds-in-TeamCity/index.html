<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Using Alexa to trigger builds in TeamCity · d' dev panda ヽ(￣(ｴ)￣)ﾉ</title><meta name="description" content="Using Alexa to trigger builds in TeamCity - Daniel Conde"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://www.devpanda.me/atom.xml" title="d' dev panda ヽ(￣(ｴ)￣)ﾉ"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/sunchongsheng" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pinggod" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Using Alexa to trigger builds in TeamCity</h1><div class="post-info">Jun 10, 2018</div><div class="post-content"><p><img src="https://res.cloudinary.com/danielcondemarin/image/upload/v1528591697/alexa_teamcity_cover_xs8rx5.jpg" alt="alexateamcity"></p>
<p>That’s right, wouldn’t be cool if you could trigger your builds from Alexa? Well, you can now, at least if you’re using TeamCity.</p>
<p><strong>What you’ll need:</strong></p>
<ul>
<li>Go (<a href="https://golang.org/dl/" target="_blank" rel="noopener">https://golang.org/dl/</a>)</li>
<li>ASK CLI (<a href="https://www.npmjs.com/package/ask-cli" target="_blank" rel="noopener">https://www.npmjs.com/package/ask-cli</a>)</li>
<li>ngrok (<a href="https://ngrok.com/download" target="_blank" rel="noopener">https://ngrok.com/download</a>)</li>
</ul>
<p>Make sure you install and setup all of that before what comes next.</p>
<p><strong>Let’s have a look at the following diagram:</strong></p>
<p><img src="https://res.cloudinary.com/danielcondemarin/image/upload/v1528586168/AlexaTeamCity_q4su1o.png" alt="diagram"></p>
<p>Note how we’re not using the typical Alexa Skill deployment approach backed by an AWS Lambda. Instead, we’re hosting a local skill server which will be publicly visible on the internet via ngrok. But why!!? Well, the reason is simple, my TeamCity Server is hosted on a private network, neither addressable on the Internet or hosted in a VPC in AWS, so AWS Lambda wasn’t an option. I guess there could be other options to expose your local TeamCity Server, but I just wanted to try this approach instead.</p>
<p><strong>Okay … how do I set it all up!?</strong></p>
<p>Ngrok will expose our local skill server to the Internet. Open a terminal and run <code>ngrok http 3000</code>, take a note of the HTTPS Forwarding URL:</p>
<p><img src="https://res.cloudinary.com/danielcondemarin/image/upload/v1528463102/AlexaTeamCity_ngrok_epnugo.png" alt="ngrok"></p>
<p>Keep ngrok running, we’ll comeback to it later.</p>
<p>Next, pull and install the local skill server: </p>
<p><code>go get github.com/danielcondemarin/ci-commander/alexa-teamcity</code></p>
<p>Open another terminal and go to the project src (Pro Tip: Use <code>tmux</code>):</p>
<p><code>cd $GOPATH/src/github.com/danielcondemarin/ci-commander/alexa-teamcity/</code></p>
<p>Edit the file <code>skill.json</code> and add your ngrok HTTPS Forwarding URL to apis.custom.endpoint.uri (Leave /echo/teamcity in the path!). Mine looked like:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&quot;apis&quot;: &#123;</span><br><span class="line">      &quot;custom&quot;: &#123;</span><br><span class="line">        &quot;endpoint&quot;: &#123;</span><br><span class="line">          &quot;sslCertificateType&quot;: &quot;Wildcard&quot;,</span><br><span class="line">          &quot;uri&quot;: &quot;https://12db3c1b.ngrok.io/echo/teamcity&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;interfaces&quot;: []</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>It’s time now to add your build types to the interaction model. We need this so Alexa can identify them in the user utterances. For example:</p>
<p><img src="https://res.cloudinary.com/danielcondemarin/image/upload/v1528538256/AlexaTeamCityUtterance_ejvrb4.png" alt="Utterance"></p>
<p>Open <code>models/en-GB.json</code>, go to <code>types[].values[]</code> and add your builds with its synonyms. If you have one of those strange build ids with underscores etc. you can set the “value” with the original build id, then synonyms can be easier to pronounce. For example, this is what my config looks like:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&quot;types&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;values&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">              &quot;name&quot;: &#123;</span><br><span class="line">                &quot;value&quot;: &quot;SuperPoo_Build&quot;,</span><br><span class="line">                &quot;synonyms&quot;: [&quot;superpoo&quot;, &quot;poo&quot;]</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          ],</span><br><span class="line">          &quot;name&quot;: &quot;BuildType&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br></pre></td></tr></table></figure>
<p>We’re nearly there now! If you haven’t already, run <code>ask init</code> and setup your profile etc.</p>
<p>Then, make sure you’re in the directory <code>alexa-teamcity</code> and deploy the skill interaction model:</p>
<p><code>ask deploy</code></p>
<p>Lastly, grab the alexa <code>skill_id</code> form the file <code>.ask/config</code> and spin up the local skill server. Make sure you replace the env variables with your own values:</p>
<p><code>ALEXA_APP_ID=&quot;amzn1.ask.skill.xxxx-xxx&quot; TEAMCITY_URL=&quot;http://127.0.0.1:8111&quot; TEAMCITY_USER=&quot;user&quot; TEAMCITY_PASS=&quot;pwd&quot; /Users/daniel/Projects/go/bin/alexa-teamcity</code></p>
<p>If you’ve reached this point without issues, here is a quick demo of what you should be able to do!</p>
<div class="video-container"><iframe src="//player.vimeo.com/video/274291984" frameborder="0" allowfullscreen></iframe></div>
<p><strong>Final Notes</strong></p>
<p>Apart from the learning involved in setting it all up, there is no reason why you couldn’t use this with an amazon echo and bring your CI to a whole new level of fun in the office! </p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/05/26/Alexa-Go-Local/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2018 <a href="https://www.devpanda.me">Daniel Conde</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>