<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> AWS CodePipeline - Integrating with TeamCity · d' dev panda ヽ(￣(ｴ)￣)ﾉ</title><meta name="description" content="AWS CodePipeline - Integrating with TeamCity - Daniel Conde"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://www.devpanda.me/atom.xml" title="d' dev panda ヽ(￣(ｴ)￣)ﾉ"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/danielcondemarin" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">AWS CodePipeline - Integrating with TeamCity</h1><div class="post-info">Nov 5, 2017</div><div class="post-content"><p>AWS CodePipeline is an excellent tool for orchestrating your deployments in the cloud. It provides out of the box integration with  CI Providers such as CodeBuild, Jenkins and Solano CI. Other providers can be configured as well, like TeamCity, and that’s the aim of this post.</p>
<p>In order to understand the extensibility point in CodePipeline that allows to plugin a custom action like a TeamCity Build, read <a href="http://docs.aws.amazon.com/codepipeline/latest/userguide/actions-create-custom-action.html" target="_blank" rel="noopener">http://docs.aws.amazon.com/codepipeline/latest/userguide/actions-create-custom-action.html</a> which explains in depth custom action types in CodePipeline.</p>
<p>We will be setting up a deployment pipeline to automate releases of a simple nodejs app hosted in GitHub. To provision the Pipeline, we will use CloudFormation, which means you can provision it in an automated fashion. </p>
<p>So, let’s start by creating our project folder, let’s call it <code>node-app-devops</code>. Next, create a directory inside the project called <code>templates</code>, which is where your cloud formation template will be, let’s name it <code>deployment-pipeline.yaml</code>.</p>
<p>Open <code>deployment-pipeline.yaml</code> in an editor of your preference and let’s start by adding a <strong>Description</strong> to your template, and the <strong>Parameters</strong>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">Description: &gt;</span><br><span class="line">    This template will provision the  CodePipeline for the App.</span><br><span class="line">    (Pipeline) GitHub -&gt; TeamCity</span><br><span class="line"></span><br><span class="line">Parameters:</span><br><span class="line">   </span><br><span class="line">    GitHubOwner:</span><br><span class="line">        Description: Repository Owner</span><br><span class="line">        Type: String</span><br><span class="line">    </span><br><span class="line">    GitHubRepo:</span><br><span class="line">        Description: Repository Name</span><br><span class="line">        Type: String</span><br><span class="line">   </span><br><span class="line">    GitHubBranch:</span><br><span class="line">        Description: Repository Branch</span><br><span class="line">        Type: String</span><br><span class="line">   </span><br><span class="line">    GitHubOAuthToken:</span><br><span class="line">        Description: Access Token Generated via GitHub (https://github.com/settings/tokens)</span><br><span class="line">        Type: String</span><br><span class="line">   </span><br><span class="line">    TeamCityServerUrl:</span><br><span class="line">        Description: Url for TeamCity. Expected URL format, http[s]://host[:port]</span><br><span class="line">        Type: String</span><br><span class="line">   </span><br><span class="line">    TeamCityBuildId:</span><br><span class="line">        Description: Build Id for TeamCity Project</span><br><span class="line">        Type: String</span><br><span class="line">   </span><br><span class="line">    TeamCityActionId:</span><br><span class="line">        Description: Action Id for Codepipeline integration with TeamCity</span><br><span class="line">        Type: String</span><br></pre></td></tr></table></figure>
<p><code>GitHubOwner</code> would be simply your GitHub username, <code>GitHubRepo</code> the name of the repository and <code>GitHubBranch</code> is the branch where CodePipeline will fetch from. <code>GitHubOAuthToken</code> can be created if you don’t have one already, by going to <a href="https://github.com/settings/tokens" target="_blank" rel="noopener">https://github.com/settings/tokens</a>.</p>
<p>So far, it should be looking like this:</p>
<p><img src="https://res.cloudinary.com/danielcondemarin/image/upload/v1509871274/AWS-CodePipeline-Integrating-with-TeamCity/description_and_parameters.png" alt="Description And Parameters"></p>
<p>Next, let’s work on the <code>Resources</code> section, starting with the IAM Role used by the Pipeline. The role will provide access to an S3 Bucket, which will store the artifacts.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Resources:</span><br><span class="line">   </span><br><span class="line">    CodePipelineServiceRole:</span><br><span class="line">        Type: AWS::IAM::Role</span><br><span class="line">        Properties:</span><br><span class="line">            RoleName: !Sub &apos;cpsr-$&#123;AWS::StackName&#125;&apos;</span><br><span class="line">            Path: /</span><br><span class="line">            AssumeRolePolicyDocument: </span><br><span class="line">                Statement:</span><br><span class="line">                    -</span><br><span class="line">                        Effect: Allow</span><br><span class="line">                        Principal:</span><br><span class="line">                            Service:</span><br><span class="line">                                - codepipeline.amazonaws.com</span><br><span class="line">                        Action:</span><br><span class="line">                            - sts:AssumeRole</span><br><span class="line">            Policies:</span><br><span class="line">                - </span><br><span class="line">                    PolicyName: !Sub &apos;cpsrp-$&#123;AWS::StackName&#125;&apos;</span><br><span class="line">                    PolicyDocument:</span><br><span class="line">                        Statement:</span><br><span class="line">                            - Resource:</span><br><span class="line">                                - !Sub &apos;arn:aws:s3:::$&#123;ArtifactBucket&#125;/*&apos;</span><br><span class="line">                              Effect: Allow</span><br><span class="line">                              Action: </span><br><span class="line">                                - s3:PutObject</span><br><span class="line">                                - s3:GetObject</span><br><span class="line">    </span><br><span class="line">    ArtifactBucket:</span><br><span class="line">        Type: AWS::S3::Bucket</span><br><span class="line">        DeletionPolicy: Retain</span><br></pre></td></tr></table></figure>
<p>Note, how in <strong>RoleName</strong> I’m using <code>cpsr-${AWS::StackName}</code>, as convention <strong>cpsr</strong> stands for the initials of the Resource being provisioned, and we append the Pseudo Parameter <code>AWS::StackName</code> to have a more unique name which can also be easily associated to the Stack.<br>In the <code>Policies</code> there will be one that provides the S3 access needed by the Pipeline.<code>ArtifactBucket</code> is simply the S3 bucket that will be used as intermediate storage between TeamCity and CodePipeline.</p>
<p>Next, let’s do the actual integration with TeamCity on our pipeline. For that, we need a <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-codepipeline-customactiontype.htm" target="_blank" rel="noopener">Custom Action Type</a>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">TeamCityBuildActionType:</span><br><span class="line">    Type: AWS::CodePipeline::CustomActionType</span><br><span class="line">    Properties:</span><br><span class="line">        Version: 1</span><br><span class="line">        Category: Build</span><br><span class="line">        Provider: TeamCity</span><br><span class="line">        Settings:</span><br><span class="line">            EntityUrlTemplate: &apos;&#123;Config:TeamCityServerURL&#125;/viewType.html?buildTypeId=&#123;Config:BuildConfigurationID&#125;&apos;</span><br><span class="line">            ExecutionUrlTemplate: &apos;&#123;Config:TeamCityServerURL&#125;/viewLog.html?buildId=&#123;ExternalExecutionId&#125;&amp;tab=buildResultsDiv&apos;</span><br><span class="line">        ConfigurationProperties:</span><br><span class="line">            - Name: TeamCityServerURL</span><br><span class="line">              Description: The expected URL format is http:[s]://host[:port]</span><br><span class="line">              Required: true</span><br><span class="line">              Key: true</span><br><span class="line">              Secret: false</span><br><span class="line">              Queryable: false</span><br><span class="line">              Type: String</span><br><span class="line">            - Name: BuildConfigurationID</span><br><span class="line">              Description: TeamCity configuration external Id</span><br><span class="line">              Required: true</span><br><span class="line">              Key: true</span><br><span class="line">              Secret: false</span><br><span class="line">              Queryable: false</span><br><span class="line">              Type: String</span><br><span class="line">            - Name: ActionID</span><br><span class="line">              Description: &gt; </span><br><span class="line">                  Must be unique, match the corresponding field in TeamCity build trigger settings and satisfy regular expression pattern: [a-zA-Z0-9_-]+] and have length &lt;= 20</span><br><span class="line">              Required: true</span><br><span class="line">              Key: true</span><br><span class="line">              Secret: false</span><br><span class="line">              Queryable: true</span><br><span class="line">              Type: String</span><br><span class="line">        InputArtifactDetails:</span><br><span class="line">            MaximumCount: 5</span><br><span class="line">            MinimumCount: 0</span><br><span class="line">        OutputArtifactDetails:</span><br><span class="line">            MaximumCount: 5</span><br><span class="line">            MinimumCount: 0</span><br></pre></td></tr></table></figure>
<p>Note that ActionID is the value that will link TeamCity together with CodePipeline, but more on that later.</p>
<p>Lastly, let’s bring all the pieces together and implement the actual CodePipeline:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Pipeline:</span><br><span class="line">    Type: AWS::CodePipeline::Pipeline</span><br><span class="line">    Properties:</span><br><span class="line">        RoleArn: !GetAtt CodePipelineServiceRole.Arn</span><br><span class="line">        ArtifactStore:</span><br><span class="line">            Type: S3</span><br><span class="line">            Location: !Ref ArtifactBucket</span><br><span class="line">        Stages:</span><br><span class="line">            - Name: Source</span><br><span class="line">              Actions:</span><br><span class="line">                  - Name: GitHubSource</span><br><span class="line">                    ActionTypeId: </span><br><span class="line">                        Category: Source</span><br><span class="line">                        Owner: ThirdParty</span><br><span class="line">                        Version: 1</span><br><span class="line">                        Provider: GitHub</span><br><span class="line">                    Configuration:</span><br><span class="line">                        Owner: !Ref GitHubOwner</span><br><span class="line">                        Repo: !Ref GitHubRepo</span><br><span class="line">                        Branch: !Ref GitHubBranch</span><br><span class="line">                        OAuthToken: !Ref GitHubOAuthToken</span><br><span class="line">                    OutputArtifacts:</span><br><span class="line">                        - Name: AppRepo</span><br><span class="line">            - Name: Build</span><br><span class="line">              Actions:</span><br><span class="line">                  - Name: TeamCityBuild</span><br><span class="line">                    ActionTypeId:</span><br><span class="line">                        Category: Build</span><br><span class="line">                        Owner: Custom</span><br><span class="line">                        Version: 1</span><br><span class="line">                        Provider: TeamCity</span><br><span class="line">                    Configuration:</span><br><span class="line">                        TeamCityServerURL: !Ref TeamCityServerUrl</span><br><span class="line">                        BuildConfigurationID: !Ref TeamCityBuildId</span><br><span class="line">                        ActionID: !Ref TeamCityActionId</span><br><span class="line">                    InputArtifacts:</span><br><span class="line">                        - Name: AppRepo</span><br><span class="line">                    OutputArtifacts:</span><br><span class="line">                        - Name: BuildOutput</span><br></pre></td></tr></table></figure>
<p>I know what you’re thinking, there is a missing piece, which is the deployment stage right? :) Well the purpose of the post is to show how to integrate with TeamCity your CodePipeline, so we’ll keep it simple, and maybe have another post later on how to integrate with other services for deploying.</p>
<p>Let’s now create the BuildConfiguration in TeamCity for the app, but first, we need to install a plugin which will be responsible for pulling any build jobs provided by the Pipeline. The plugin can be found <a href="https://confluence.jetbrains.com/display/TW/AWS+CodePipeline+Plugin" target="_blank" rel="noopener">here</a>. If you’ve never installed a plugin before on TeamCity, just go to <strong>Administration &gt; Plugins List</strong> and click on <strong>Upload plugin zip</strong>. You can get the plugin zip from the link above. You might need to restart the TeamCity server after uploading the plugin. Should look this after installing it:</p>
<p><img src="https://res.cloudinary.com/danielcondemarin/image/upload/v1509908370/AWS-CodePipeline-Integrating-with-TeamCity/teamcityplugins.png" alt="TeamCity Plugins"></p>
<p>Note how I’ve got a plugin for better nodejs integration with TeamCity, that will come handy when we configure our build. You can find it <a href="https://github.com/jonnyzzz/TeamCity.Node" target="_blank" rel="noopener">here</a>, install it like you did for the previous one.</p>
<p>Create a new Project in TeamCity, and a build configuration, skip the VCS setup, since our repository will come from CodePipeline instead of a version control provider. I named my project <code>Demo App</code>, and the build configuration <code>DemoAppBuild</code>. First, we need to configure a Trigger, which will execute the build configuration whenever the Pipeline needs it to. If you’ve installed correctly the CodePipeline plugin for TeamCity, you should be able to configure the trigger like this:<br><img src="https://res.cloudinary.com/danielcondemarin/image/upload/v1509909920/AWS-CodePipeline-Integrating-with-TeamCity/codepipelinetrigger.png" alt="CodePipeline Trigger"><br>Use your own AWS Access Keys. Also, in ActionID just put anything meaningful, this will be the value that will tie together your build configuration with the Pipeline in AWS.</p>
<p>Now let’s configure the Build Steps. I have 5 build steps:</p>
<p><img src="https://res.cloudinary.com/danielcondemarin/image/upload/v1509910295/AWS-CodePipeline-Integrating-with-TeamCity/buildsteps.png" alt="Build Steps">.</p>
<p>Steps 1, 3 and 4 can be configured easily by using the jonnyzzz plugin mentioned above, so I won’t go in detail for these. Now, let’s have a look at step <code>2. Copy Repository To Working Directory</code>. This is a command line script which will pickup the repository dropped by CodePipeline and copy it to the build working directory:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"># vars</span><br><span class="line">repo_input_zip=&quot;%codepipeline.artifact.input.folder%/AppRepo.zip&quot;</span><br><span class="line"></span><br><span class="line"># unzip repo to working directory</span><br><span class="line">unzip $repo_input_zip -d %teamcity.build.workingDir%</span><br></pre></td></tr></table></figure>
<p>The variable <code>%codepipeline.artifact.input.folder%</code> is automatically setup by the plugin, and points to the directory where the repository will be dropped.</p>
<p>Let’s have a look now at the last step: <code>5. Copy Repository To CodePipeline Output Directory</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"># vars</span><br><span class="line">repo_output_zip=&quot;%codepipeline.artifact.output.folder%/BuildOutput.zip&quot;</span><br><span class="line"></span><br><span class="line"># zip &amp; copy repo to output directory for codepipeline</span><br><span class="line">zip -r $repo_output_zip %teamcity.build.workingDir%</span><br></pre></td></tr></table></figure>
<p>This step will basically copy the build artifact to the pickup directory for CodePipeline to copy from.</p>
<p>It is demo time now, so let’s go ahead now and launch our stack:</p>
<p><a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/new?stackName=AppPipeline&amp;templateURL=https://s3-eu-west-1.amazonaws.com/devpanda-bucket/node-app-devops/cf-templates/deployment-pipeline.yaml" target="_blank" rel="noopener"><img src="https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png" alt="Launch Stack"></a></p>
<p>After following the Launch Stack link, you should get a screen like this:</p>
<p><img src="https://res.cloudinary.com/danielcondemarin/image/upload/v1509914716/AWS-CodePipeline-Integrating-with-TeamCity/cf-launch-parameters.png" alt="Stack Launch"></p>
<p>Make sure you replace <code>GitHubOAuthToken</code> with your own and the <code>TeamCityServerUrl</code> as well. The app node-demo-app is hosted on my account <a href="https://github.com/danielcondemarin/node-demo-app" target="_blank" rel="noopener">here</a><br>You should have access to it with your token, if not, just fork it and use  your own username and repository. Now follow the Stack creation, and after completion it should look like:</p>
<p><img src="https://res.cloudinary.com/danielcondemarin/image/upload/v1509915058/AWS-CodePipeline-Integrating-with-TeamCity/stackcompleted.png" alt="Stack Created"></p>
<p>After the Stack is created, it will automatically trigger the CodePipeline which should all work as expected. </p>
<p><img src="https://res.cloudinary.com/danielcondemarin/image/upload/v1509915396/AWS-CodePipeline-Integrating-with-TeamCity/codepipelinesuccess.png" alt="Pipeline Success"></p>
<p>That is the end of this post, hope you enjoyed it, and is of good use in your devops toolbelt ;). All the sources for the demo can be found on the repo : <a href="https://github.com/danielcondemarin/node-app-devops" target="_blank" rel="noopener">https://github.com/danielcondemarin/node-app-devops</a>.</p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/02/16/Simple-Angular-and-React-Hybrid-App/" class="prev">PREV</a><a href="/2017/10/07/DNS-Blacklist-of-locations-countries-using-AWS-Route53/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2018 <a href="https://www.devpanda.me">Daniel Conde</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>