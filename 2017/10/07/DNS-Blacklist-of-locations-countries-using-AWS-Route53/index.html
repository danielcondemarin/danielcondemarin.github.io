<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> AWS Route53 - DNS Whitelisting using Geolocation Routing · devpanda</title><meta name="description" content="AWS Route53 - DNS Whitelisting using Geolocation Routing - Daniel Conde"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://www.devpanda.me/atom.xml" title="devpanda"><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-107848675-1",'auto');ga('send','pageview');</script></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/images/logo.jpg" alt="logo"></a><a href="https://stackoverflow.com/users/954852/daniel" target="_blank" class="so-flair"><img src="https://stackoverflow.com/users/flair/954852.png?theme=clean" width="208" height="58" alt="profile for Daniel at Stack Overflow, Q&amp;amp;A for professional and enthusiast programmers" title="profile for Daniel at Stack Overflow, Q&amp;amp;A for professional and enthusiast programmers"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/danielcondemarin" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">AWS Route53 - DNS Whitelisting using Geolocation Routing</h1><div class="post-info">Oct 7, 2017</div><div class="post-content"><p>Assumptions:  Basic knowledge of AWS Route53</p>
<p>DNS can be a powerful tool, more so if you are using AWS Route53 as your provider.</p>
<p>In this post I will focus on how to use Route53’s <a href="http://docs.aws.amazon.com/Route53/latest/DeveloperGuide/routing-policy.html#routing-policy-geo" target="_blank" rel="external">Geolocation routing</a> as a whitelist / blacklist of users originating from around the world.</p>
<p>So, let’s assume you only want users from the United Kingdom to access your website. This could be because all your customer base and operations are UK based, or maybe your application was DDoS’ed from various countries around the world, and you want to make sure any DNS query issued from this malicious Origin / IP is null routed.</p>
<p>First, let’s go to Route53 and create our first record set :</p>
<p><img src="http://res.cloudinary.com/danielcondemarin/image/upload/v1507497187/nullrouteset.png" alt="Null Route"></p>
<p>Please note this will be our default route, which will resolve to the IP Address <a href="https://en.wikipedia.org/wiki/Null_route" target="_blank" rel="external">0.0.0.0</a>. So, whenever a user attempts to reach your website domain (i.e. mywebsite.somedomain.co.uk) Route53 will resolve that DNS Query to <code>0.0.0.0</code>, then your machine will attempt to reach the website via the IP 0.0.0.0 which obviously doesn’t exist and will fail.</p>
<p>Let’s setup now the record for users originating from the UK and assume our webserver will be hosted on a server with IP <code>54.12.12.12</code> :</p>
<p><img src="http://res.cloudinary.com/danielcondemarin/image/upload/v1507497187/ukrouteset.png" alt="UK Route"></p>
<p>That should be it, the A records just created along with the domain NS records should be listed in your website Hosted Zone like this:</p>
<p><img src="http://res.cloudinary.com/danielcondemarin/image/upload/v1507497187/hostedzone.png" alt="Hosted Zone"></p>
<p>But how do we test this is working correctly? It should be easy be using <code>dig</code> via your terminal. Just grab one of the nameservers for your domain, listed above, and run the following command :</p>
<p><code>./bin/dig/dig @your-nameserver mywebsite.somedomain.co.uk +client=45.63.111.158/24</code></p>
<p>Caveat : You will need a <a href="https://www.gsic.uva.es/~jnisigl/dig-edns-client-subnet.html" target="_blank" rel="external">patched version</a> of <code>dig</code> in order to use the <code>+client</code> option. This option allows you to tell the nameserver the user ip address, which then it uses to return an IP Address from your records, based on the estimated geolocation of the IP Address you passed. This mainly works thanks to the <a href="https://tools.ietf.org/html/rfc7871" target="_blank" rel="external">client subnet in DNS queries</a>. </p>
<p><img src="http://res.cloudinary.com/danielcondemarin/image/upload/v1507500087/usdnsquery.png" alt="DNS Query with American IP Address"></p>
<p>I used the IP Address <code>45.63.111.158</code> which is from an American DNS Server I’ve found here <a href="https://public-dns.info/" target="_blank" rel="external">https://public-dns.info/</a>. Make sure you look again for a different IP since this might change.</p>
<p>Now, for the UK:</p>
<p><img src="http://res.cloudinary.com/danielcondemarin/image/upload/v1507500087/ukdnsquery.png" alt="DNS Query with UK IP Address"></p>
<p>That’s about it really, hope you found it interesting and give some real use to it.</p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/06/25/SSH-Public-Key-authentication-to-your-Edison/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'devpanda-me';
var disqus_identifier = '2017/10/07/DNS-Blacklist-of-locations-countries-using-AWS-Route53/';
var disqus_title = 'AWS Route53 - DNS Whitelisting using Geolocation Routing';
var disqus_url = 'https://www.devpanda.me/2017/10/07/DNS-Blacklist-of-locations-countries-using-AWS-Route53/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//devpanda-me.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2017 <a href="https://www.devpanda.me">Daniel Conde</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>